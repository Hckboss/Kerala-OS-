<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Byte OS v3.4 - Full Suite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;600&family=Noto+Sans+Malayalam:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            cursor: default;
            overflow: hidden;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            user-select: none;
            background-color: #000;
        }
        
        /* CRT & Scanline Effects */
        .scanline {
            width: 100%;
            height: 100px;
            z-index: 10;
            background: linear-gradient(0deg, rgba(0,0,0,0) 0%, rgba(255, 255, 255, 0.2) 50%, rgba(0,0,0,0) 100%);
            opacity: 0.1;
            position: absolute;
            bottom: 100%;
            animation: scanline 10s linear infinite;
            pointer-events: none;
        }
        @keyframes scanline { 0% { bottom: 100%; } 100% { bottom: -100%; } }

        /* Glassmorphism */
        .glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .glass-dark {
            background: rgba(15, 23, 42, 0.85); /* Slate 900 */
            backdrop-filter: blur(12px);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Desktop Grid */
        .desktop-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, 100px);
            grid-auto-rows: 100px;
            height: calc(100vh - 48px);
            padding: 10px;
            align-content: start;
        }
        
        /* Icon Selection Styles */
        .desktop-icon { border: 1px solid transparent; }
        .desktop-icon:hover { background-color: rgba(255, 255, 255, 0.1); border-radius: 4px; }
        .desktop-icon.selected { 
            background-color: rgba(255, 255, 255, 0.2); 
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 4px;
        }

        /* Utilities */
        .font-mono { font-family: 'Fira Code', monospace; }
        .font-malayalam { font-family: 'Noto Sans Malayalam', sans-serif; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        
        .animate-blink { animation: blink 1s infinite; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }

        /* BSOD */
        #bsod {
            display: none;
            position: absolute;
            top: 0; left: 0; width: 100vw; height: 100vh;
            background-color: #0078D7;
            color: white;
            z-index: 99999;
            padding: 10% 15%;
            font-family: 'Segoe UI', sans-serif;
        }
    </style>
</head>
<body class="text-white h-screen w-screen overflow-hidden" oncontextmenu="return false;">

    <!-- BSOD SCREEN -->
    <div id="bsod">
        <div class="text-9xl mb-4">:(</div>
        <div class="text-2xl mb-8">Your PC ran into a problem and needs to restart. We're just collecting some error info, and then we'll restart for you.</div>
        <div class="text-xl">0% complete</div>
        <br>
        <div class="text-sm font-mono mt-8">
            Stop Code: CRITICAL_PROCESS_DIED<br>
            What failed: keralinux.sys
        </div>
    </div>

    <!-- BOOT SCREEN -->
    <div id="boot-screen" class="absolute inset-0 bg-black z-50 flex flex-col justify-start p-10 font-mono text-green-500 overflow-hidden">
        <div id="boot-text" class="text-sm md:text-base"></div>
    </div>

    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="hidden absolute inset-0 bg-slate-900 z-40 flex flex-col items-center justify-center bg-cover bg-center" style="background-image: url('https://images.unsplash.com/photo-1602216056096-3b40cc0c9944?q=80&w=3270&auto=format&fit=crop');">
        <div class="absolute inset-0 bg-black/50 backdrop-blur-sm"></div>
        <div class="z-10 bg-black/40 p-8 rounded-2xl glass border border-white/10 shadow-2xl flex flex-col items-center w-80">
            <div class="w-24 h-24 rounded-full bg-gradient-to-br from-indigo-600 to-purple-600 flex items-center justify-center mb-4 shadow-lg border-2 border-white/20">
                <i class="fas fa-user-cog text-4xl text-white"></i>
            </div>
            <h2 class="text-2xl font-semibold text-white mb-1">Hash</h2>
            <p class="text-gray-300 text-sm mb-6">Technician & Admin</p>
            <div class="w-full relative">
                <input type="password" id="password-input" placeholder="Password" class="w-full bg-white/10 border border-white/20 rounded-lg py-2 px-4 text-white focus:outline-none focus:border-indigo-400 placeholder-gray-400 transition-all">
                <button onclick="login()" class="absolute right-2 top-2 text-gray-400 hover:text-white"><i class="fas fa-arrow-right"></i></button>
            </div>
            <p class="mt-4 text-xs text-indigo-400 opacity-0 transition-opacity" id="login-msg">Mounting /dev/sda1...</p>
        </div>
        <div class="absolute bottom-10 text-white/60 text-sm font-malayalam">Byte OS v3.4 &bull; Full Suite Edition</div>
    </div>

    <!-- DESKTOP ENVIRONMENT -->
    <div id="desktop" class="hidden absolute inset-0 h-full w-full bg-cover bg-center overflow-hidden transition-all duration-700" style="background-image: url('https://images.unsplash.com/photo-1602216056096-3b40cc0c9944?q=80&w=3270&auto=format&fit=crop');">
        
        <!-- Icons -->
        <div class="desktop-grid" id="desktop-icons-container"></div>

        <!-- Windows Layer -->
        <div id="windows-container" class="absolute inset-0 pointer-events-none"></div>

        <!-- Context Menu -->
        <div id="context-menu" class="hidden absolute w-48 bg-slate-800/95 backdrop-blur border border-slate-600 rounded-lg shadow-2xl z-[9999] flex flex-col py-1 text-sm text-gray-200">
            <button onclick="ctxRefresh()" class="text-left px-4 py-2 hover:bg-indigo-600 hover:text-white transition-colors flex items-center"><i class="fas fa-sync-alt w-5"></i> Refresh</button>
            <div class="h-[1px] bg-slate-600 my-1"></div>
            <button onclick="ctxNewFolder()" class="text-left px-4 py-2 hover:bg-indigo-600 hover:text-white transition-colors flex items-center"><i class="fas fa-folder-plus w-5"></i> New Folder</button>
            <button onclick="ctxChangeWallpaper()" class="text-left px-4 py-2 hover:bg-indigo-600 hover:text-white transition-colors flex items-center"><i class="fas fa-image w-5"></i> Next Wallpaper</button>
            <div class="h-[1px] bg-slate-600 my-1"></div>
            <button onclick="openApp('settings')" class="text-left px-4 py-2 hover:bg-indigo-600 hover:text-white transition-colors flex items-center"><i class="fas fa-sliders-h w-5"></i> Properties</button>
        </div>

        <!-- Start Menu -->
        <div id="start-menu" class="absolute bottom-14 left-2 w-80 max-h-[500px] overflow-hidden bg-slate-900/95 glass border border-white/10 rounded-lg shadow-2xl transform scale-90 opacity-0 pointer-events-none transition-all duration-200 origin-bottom-left z-50 flex flex-col text-white">
            <div class="p-4 bg-gradient-to-r from-indigo-900 to-purple-900 rounded-t-lg flex items-center space-x-3 shrink-0">
                <div class="w-10 h-10 rounded-full bg-white/10 flex items-center justify-center"><i class="fas fa-user text-white"></i></div>
                <div><div class="font-bold">Hash</div><div class="text-xs text-indigo-300">System Admin</div></div>
            </div>
            <div class="p-2 grid grid-cols-1 gap-1 overflow-y-auto">
                <button onclick="openApp('terminal')" class="flex items-center space-x-3 p-2 hover:bg-white/10 rounded text-left transition-colors">
                    <div class="w-8 h-8 bg-gray-800 rounded flex items-center justify-center"><i class="fas fa-terminal text-green-400"></i></div><span>Terminal</span>
                </button>
                <button onclick="openApp('filemanager')" class="flex items-center space-x-3 p-2 hover:bg-white/10 rounded text-left transition-colors">
                    <div class="w-8 h-8 bg-indigo-700 rounded flex items-center justify-center"><i class="fas fa-folder text-indigo-200"></i></div><span>File Manager</span>
                </button>
                <button onclick="openApp('browser')" class="flex items-center space-x-3 p-2 hover:bg-white/10 rounded text-left transition-colors">
                    <div class="w-8 h-8 bg-orange-700 rounded flex items-center justify-center"><i class="fab fa-firefox-browser text-white"></i></div><span>Web Browser</span>
                </button>
                 <button onclick="openApp('texteditor')" class="flex items-center space-x-3 p-2 hover:bg-white/10 rounded text-left transition-colors">
                    <div class="w-8 h-8 bg-gray-700 rounded flex items-center justify-center"><i class="fas fa-file-alt text-gray-300"></i></div><span>Text Editor</span>
                </button>
                <button onclick="openApp('calculator')" class="flex items-center space-x-3 p-2 hover:bg-white/10 rounded text-left transition-colors">
                    <div class="w-8 h-8 bg-teal-700 rounded flex items-center justify-center"><i class="fas fa-calculator text-white"></i></div><span>Calculator</span>
                </button>
                <button onclick="openApp('paint')" class="flex items-center space-x-3 p-2 hover:bg-white/10 rounded text-left transition-colors">
                    <div class="w-8 h-8 bg-pink-700 rounded flex items-center justify-center"><i class="fas fa-palette text-white"></i></div><span>Pixel Paint</span>
                </button>
                <button onclick="openApp('cctv')" class="flex items-center space-x-3 p-2 hover:bg-white/10 rounded text-left transition-colors">
                    <div class="w-8 h-8 bg-blue-900 rounded flex items-center justify-center"><i class="fas fa-video text-blue-300"></i></div><span>CCTV Hub</span>
                </button>
                <button onclick="openApp('settings')" class="flex items-center space-x-3 p-2 hover:bg-white/10 rounded text-left transition-colors">
                    <div class="w-8 h-8 bg-slate-700 rounded flex items-center justify-center"><i class="fas fa-cog text-gray-300"></i></div><span>Settings</span>
                </button>
            </div>
            <div class="p-3 border-t border-white/10 flex justify-between shrink-0">
                <button onclick="location.reload()" class="text-gray-400 hover:text-white text-xs"><i class="fas fa-power-off mr-1"></i> Restart</button>
                <button class="text-gray-400 hover:text-white text-xs"><i class="fas fa-lock mr-1"></i> Lock</button>
            </div>
        </div>

        <!-- Taskbar -->
        <div class="absolute bottom-0 left-0 right-0 h-12 glass-dark flex items-center justify-between px-2 z-40">
            <div class="flex items-center space-x-1 h-full">
                <button onclick="toggleStartMenu()" class="h-10 w-10 flex items-center justify-center hover:bg-white/10 rounded transition-colors group relative">
                    <i class="fas fa-fan text-indigo-500 text-xl group-hover:rotate-180 transition-transform duration-700"></i>
                </button>
                <div class="w-[1px] h-6 bg-white/20 mx-2"></div>
                <!-- App Launcher Icons -->
                <button onclick="toggleWindow('terminal')" class="h-10 w-10 flex items-center justify-center hover:bg-white/10 rounded transition-colors relative" title="Terminal"><i class="fas fa-terminal text-gray-300"></i><div id="indicator-terminal" class="hidden absolute bottom-1 w-1 h-1 bg-green-500 rounded-full"></div></button>
                <button onclick="toggleWindow('filemanager')" class="h-10 w-10 flex items-center justify-center hover:bg-white/10 rounded transition-colors relative" title="Files"><i class="fas fa-folder text-indigo-400"></i><div id="indicator-filemanager" class="hidden absolute bottom-1 w-1 h-1 bg-green-500 rounded-full"></div></button>
                <button onclick="toggleWindow('browser')" class="h-10 w-10 flex items-center justify-center hover:bg-white/10 rounded transition-colors relative" title="Browser"><i class="fab fa-firefox-browser text-orange-400"></i><div id="indicator-browser" class="hidden absolute bottom-1 w-1 h-1 bg-green-500 rounded-full"></div></button>
                 <button onclick="toggleWindow('calculator')" class="h-10 w-10 flex items-center justify-center hover:bg-white/10 rounded transition-colors relative" title="Calculator"><i class="fas fa-calculator text-teal-400"></i><div id="indicator-calculator" class="hidden absolute bottom-1 w-1 h-1 bg-green-500 rounded-full"></div></button>
                 <button onclick="toggleWindow('cctv')" class="h-10 w-10 flex items-center justify-center hover:bg-white/10 rounded transition-colors relative" title="CCTV"><i class="fas fa-video text-blue-300"></i><div id="indicator-cctv" class="hidden absolute bottom-1 w-1 h-1 bg-green-500 rounded-full"></div></button>
            </div>
            <div class="flex items-center space-x-4 pr-3 text-xs text-gray-300">
                <div class="flex flex-col items-end"><span id="clock-time" class="font-bold text-white text-sm">12:00</span><span id="clock-date" class="text-[10px] text-gray-400">Dec 17</span></div>
                <div class="flex space-x-3 border-l border-white/10 pl-3"><i class="fas fa-wifi text-green-400"></i><i class="fas fa-battery-full text-green-400"></i></div>
            </div>
        </div>
    </div>

    <script>
        /* --- SYSTEM CORE --- */
        const DEFAULT_FS = {
            "Desktop": { type: "dir", content: {} },
            "Documents": { type: "dir", content: { "notes.txt": { type: "file", content: "Technician Log:\n- Checked RAM on Server 1" } } },
            "Downloads": { type: "dir", content: {} },
            "CCTV": { type: "dir", content: { "log.txt": { type: "file", content: "Motion detected." } } }
        };
        const DEFAULT_SETTINGS = { wallpaperIndex: 0 };

        let fileSystem = {};
        let systemSettings = {};
        
        function initSystem() {
            // Load FS
            const savedFS = localStorage.getItem("byteos_fs_v34");
            fileSystem = savedFS ? JSON.parse(savedFS) : JSON.parse(JSON.stringify(DEFAULT_FS));
            
            // Load Settings
            const savedSet = localStorage.getItem("byteos_settings_v34");
            systemSettings = savedSet ? JSON.parse(savedSet) : JSON.parse(JSON.stringify(DEFAULT_SETTINGS));

            saveDrive(); 
            renderDesktopIcons();
            updateClock();
            initContextMenuHandler();
            
            // Apply Wallpaper
            document.getElementById('desktop').style.backgroundImage = `url('${wallpapers[systemSettings.wallpaperIndex]}')`;
        }

        function saveDrive() {
            localStorage.setItem("byteos_fs_v34", JSON.stringify(fileSystem));
            localStorage.setItem("byteos_settings_v34", JSON.stringify(systemSettings));
        }

        function resetSystem() {
            localStorage.removeItem("byteos_fs_v34");
            localStorage.removeItem("byteos_settings_v34");
            location.reload();
        }

        /* --- CONTEXT MENU & WALLPAPER --- */
        const wallpapers = [
            'https://images.unsplash.com/photo-1602216056096-3b40cc0c9944?q=80&w=3270&auto=format&fit=crop', // Kerala
            'https://images.unsplash.com/photo-1550751827-4bd374c3f58b?q=80&w=2670&auto=format&fit=crop', // Cyberpunk
            'https://images.unsplash.com/photo-1451187580459-43490279c0fa?q=80&w=2672&auto=format&fit=crop', // Earth
            'https://images.unsplash.com/photo-1518770660439-4636190af475?q=80&w=2670&auto=format&fit=crop' // Circuit
        ];

        function initContextMenuHandler() {
            const menu = document.getElementById('context-menu');
            document.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                const sm = document.getElementById('start-menu');
                if (!sm.classList.contains('opacity-0')) toggleStartMenu();
                menu.style.left = `${e.clientX}px`; menu.style.top = `${e.clientY}px`;
                menu.classList.remove('hidden');
            });
            document.addEventListener('click', (e) => {
                if (!menu.contains(e.target)) menu.classList.add('hidden');
                if (e.target.id === 'desktop' || e.target.classList.contains('desktop-grid')) {
                    document.querySelectorAll('.desktop-icon').forEach(icon => icon.classList.remove('selected'));
                }
            });
        }

        function ctxRefresh() {
            document.getElementById('context-menu').classList.add('hidden');
            const d = document.getElementById('desktop'); d.style.opacity = '0';
            setTimeout(() => { renderDesktopIcons(); d.style.opacity = '1'; }, 300);
        }
        function ctxNewFolder() {
            document.getElementById('context-menu').classList.add('hidden');
            const name = "New Folder " + Math.floor(Math.random() * 100);
            fileSystem["Desktop"].content[name] = { type: "dir", content: {} };
            saveDrive(); renderDesktopIcons();
        }
        function ctxChangeWallpaper() {
            document.getElementById('context-menu').classList.add('hidden');
            systemSettings.wallpaperIndex = (systemSettings.wallpaperIndex + 1) % wallpapers.length;
            document.getElementById('desktop').style.backgroundImage = `url('${wallpapers[systemSettings.wallpaperIndex]}')`;
            saveDrive();
        }

        /* --- BOOT & LOGIN --- */
        const hardware = { cores: navigator.hardwareConcurrency || 4, memory: navigator.deviceMemory || 8, platform: navigator.platform };
        const bootText = ["[ OK ] BIOS POST", "[ OK ] Init Filesystem", `[ OK ] CPU: ${hardware.cores} Cores`, "Welcome to Byte OS..."];
        let bootIndex = 0;
        function runBoot() {
            const c = document.getElementById('boot-text');
            if (bootIndex < bootText.length) {
                c.innerHTML += `<div class="mb-1"><span class="text-green-600 font-bold">[${(bootIndex*0.5).toFixed(2)}]</span> ${bootText[bootIndex]}</div>`;
                bootIndex++; setTimeout(runBoot, 300);
            } else {
                setTimeout(() => { document.getElementById('boot-screen').classList.add('hidden'); document.getElementById('login-screen').classList.remove('hidden'); }, 500);
            }
        }
        window.onload = () => { initSystem(); runBoot(); };
        function login() { document.getElementById('login-screen').classList.add('hidden'); document.getElementById('desktop').classList.remove('hidden'); }

        /* --- APP DEFINITIONS --- */
        const apps = {
            terminal: {
                title: "Terminal", icon: "fas fa-terminal", color: "text-green-400",
                content: `<div class="h-full bg-black text-green-500 font-mono p-2 text-sm overflow-y-auto flex flex-col" onclick="document.getElementById('term-input').focus()"><div id="term-history" class="flex-1">Byte OS v3.4<br>Type 'help'</div><div class="flex mt-1"><span class="mr-2 text-blue-400 font-bold">hash@byteos:~$</span><input type="text" id="term-input" class="bg-transparent border-none outline-none text-white flex-1" autocomplete="off"></div></div>`,
                init: initTerminal
            },
            filemanager: {
                title: "File Manager", icon: "fas fa-folder-open", color: "text-indigo-400",
                content: `<div class="h-full bg-slate-100 flex flex-col text-slate-800"><div class="bg-slate-200 p-2 border-b flex items-center"><button onclick="refreshFM()"><i class="fas fa-sync-alt"></i></button><span class="ml-2 text-xs">/home/hash/</span></div><div class="flex-1 p-4 grid grid-cols-4 gap-4 overflow-y-auto content-start" id="fm-content"></div></div>`,
                init: refreshFM
            },
            texteditor: {
                title: "Text Editor", icon: "fas fa-file-alt", color: "text-gray-300",
                content: `<div class="h-full bg-slate-50 flex flex-col"><div class="bg-slate-200 p-2 flex items-center gap-2"><button onclick="saveCurrentFile()" class="px-2 py-1 bg-indigo-600 text-white rounded text-xs">Save</button><input id="editor-filename" value="untitled.txt" class="border rounded px-1 text-xs w-32 text-black"><span id="editor-status" class="text-green-600 text-xs opacity-0">Saved!</span></div><textarea id="editor-content" class="flex-1 p-4 resize-none focus:outline-none text-black font-mono text-sm"></textarea></div>`,
                init: () => {}
            },
            calculator: {
                title: "Calculator", icon: "fas fa-calculator", color: "text-teal-400",
                content: `
                    <div class="h-full bg-slate-800 flex flex-col p-2">
                        <input type="text" id="calc-display" class="w-full bg-slate-200 text-right text-2xl p-2 rounded mb-2 font-mono text-black" readonly>
                        <div class="grid grid-cols-4 gap-2 flex-1">
                            <button onclick="calcIn('7')" class="bg-slate-700 hover:bg-slate-600 rounded text-xl font-bold">7</button>
                            <button onclick="calcIn('8')" class="bg-slate-700 hover:bg-slate-600 rounded text-xl font-bold">8</button>
                            <button onclick="calcIn('9')" class="bg-slate-700 hover:bg-slate-600 rounded text-xl font-bold">9</button>
                            <button onclick="calcIn('/')" class="bg-orange-600 hover:bg-orange-500 rounded text-xl font-bold">รท</button>
                            <button onclick="calcIn('4')" class="bg-slate-700 hover:bg-slate-600 rounded text-xl font-bold">4</button>
                            <button onclick="calcIn('5')" class="bg-slate-700 hover:bg-slate-600 rounded text-xl font-bold">5</button>
                            <button onclick="calcIn('6')" class="bg-slate-700 hover:bg-slate-600 rounded text-xl font-bold">6</button>
                            <button onclick="calcIn('*')" class="bg-orange-600 hover:bg-orange-500 rounded text-xl font-bold">ร</button>
                            <button onclick="calcIn('1')" class="bg-slate-700 hover:bg-slate-600 rounded text-xl font-bold">1</button>
                            <button onclick="calcIn('2')" class="bg-slate-700 hover:bg-slate-600 rounded text-xl font-bold">2</button>
                            <button onclick="calcIn('3')" class="bg-slate-700 hover:bg-slate-600 rounded text-xl font-bold">3</button>
                            <button onclick="calcIn('-')" class="bg-orange-600 hover:bg-orange-500 rounded text-xl font-bold">-</button>
                            <button onclick="calcIn('0')" class="bg-slate-700 hover:bg-slate-600 rounded text-xl font-bold">0</button>
                            <button onclick="calcIn('.')" class="bg-slate-700 hover:bg-slate-600 rounded text-xl font-bold">.</button>
                            <button onclick="calcRes()" class="bg-green-600 hover:bg-green-500 rounded text-xl font-bold">=</button>
                            <button onclick="calcIn('+')" class="bg-orange-600 hover:bg-orange-500 rounded text-xl font-bold">+</button>
                            <button onclick="document.getElementById('calc-display').value=''" class="col-span-4 bg-red-600 hover:bg-red-500 rounded text-lg font-bold">CLEAR</button>
                        </div>
                    </div>`,
                init: () => {}
            },
            browser: {
                title: "Web Browser", icon: "fab fa-firefox-browser", color: "text-orange-400",
                content: `
                    <div class="h-full flex flex-col bg-white">
                        <div class="bg-gray-200 p-2 flex space-x-2 border-b">
                             <div class="flex space-x-1 text-gray-500"><i class="fas fa-arrow-left"></i><i class="fas fa-arrow-right"></i><i class="fas fa-redo"></i></div>
                             <input type="text" value="https://keralatourism.org" class="flex-1 text-xs px-2 rounded border text-black" readonly>
                        </div>
                        <iframe src="https://www.wikipedia.org/wiki/Kerala" class="flex-1 w-full border-none"></iframe>
                    </div>`,
                init: () => {}
            },
            paint: {
                title: "Pixel Paint", icon: "fas fa-palette", color: "text-pink-400",
                content: `
                    <div class="h-full flex flex-col bg-gray-200">
                        <div class="p-2 bg-gray-300 flex space-x-2 border-b border-gray-400">
                            <input type="color" id="paint-color" value="#000000" class="h-6 w-6 p-0 border-0">
                            <button onclick="clearPaint()" class="px-2 bg-white rounded text-black text-xs">Clear</button>
                        </div>
                        <div class="flex-1 relative cursor-crosshair overflow-hidden bg-white">
                            <canvas id="paint-canvas" width="600" height="400" class="w-full h-full"></canvas>
                        </div>
                    </div>`,
                init: initPaint
            },
            cctv: { title: "CCTV Hub", icon: "fas fa-video", color: "text-blue-400", content: `<div class="h-full bg-slate-900 p-2 grid grid-cols-2 gap-2"><div class="bg-black relative group border border-slate-700 rounded overflow-hidden"><div class="absolute top-2 left-2 text-green-500 text-[10px] bg-black/50 px-1">CAM 01</div><img src="https://images.unsplash.com/photo-1541888946425-d81bb19240f5?w=500" class="w-full h-full object-cover opacity-60"></div><div class="bg-black relative group border border-slate-700 rounded overflow-hidden"><div class="absolute top-2 left-2 text-green-500 text-[10px] bg-black/50 px-1">CAM 02</div><img src="https://images.unsplash.com/photo-1590247813693-5541d1c609fd?w=500" class="w-full h-full object-cover opacity-60"></div></div>` },
            settings: {
                title: "Settings", icon: "fas fa-cog", color: "text-gray-400",
                content: `<div class="p-6 text-white"><b>System</b><br>CPU: ${hardware.cores} Cores<br>RAM: ${hardware.memory}GB<br><br><button onclick="resetSystem()" class="bg-red-600 px-3 py-1 rounded text-xs">Factory Reset</button></div>`
            }
        };

        /* --- WINDOW MANAGER --- */
        let zIndex = 100, activeWin = null, openWins = {};
        
        function toggleWindow(id) {
            if(openWins[id]) {
                const el = document.getElementById(`win-${id}`);
                if(el.classList.contains('hidden')) { el.classList.remove('hidden'); focusWin(id); }
                else if(activeWin !== id) focusWin(id);
                else el.classList.add('hidden');
            } else openApp(id);
        }

        function closeApp(id) {
            const w = document.getElementById(`win-${id}`); if(w) w.remove();
            delete openWins[id]; if(activeWin===id) activeWin=null;
            const i = document.getElementById(`indicator-${id}`); if(i) i.classList.add('hidden');
        }
        function minimizeApp(id) { document.getElementById(`win-${id}`).classList.add('hidden'); }
        function maximizeApp(id) { const w=document.getElementById(`win-${id}`); w.classList.toggle('w-full'); w.classList.toggle('h-full'); w.classList.toggle('top-0'); w.classList.toggle('left-0'); }

        function openApp(id, args) {
            if(openWins[id]) { 
                const el = document.getElementById(`win-${id}`); 
                el.classList.remove('hidden'); 
                focusWin(id); 
                if(id==='texteditor' && args) loadFileIntoEditor(args); 
                return; 
            }
            const app = apps[id];
            const win = document.createElement('div');
            win.id = `win-${id}`;
            win.className = "absolute flex flex-col bg-slate-900 rounded-lg border border-slate-700 shadow-2xl overflow-hidden w-[600px] h-[400px] pointer-events-auto";
            win.style.zIndex = ++zIndex;
            win.style.top = (50 + Math.random()*50) + "px"; win.style.left = (50 + Math.random()*50) + "px";
            win.innerHTML = `<div class="bg-slate-800 p-2 flex justify-between cursor-move title-bar" onmousedown="focusWin('${id}')"><div class="flex items-center gap-2 text-gray-200 text-sm"><i class="${app.icon} ${app.color}"></i>${app.title}</div><div class="flex gap-2"><button onclick="closeApp('${id}')" class="w-3 h-3 rounded-full bg-red-500 hover:bg-red-400"></button><button onclick="minimizeApp('${id}')" class="w-3 h-3 rounded-full bg-yellow-500 hover:bg-yellow-400"></button><button onclick="maximizeApp('${id}')" class="w-3 h-3 rounded-full bg-green-500 hover:bg-green-400"></button></div></div><div class="flex-1 overflow-hidden relative">${app.content}</div>`;
            document.getElementById('windows-container').appendChild(win);
            makeDraggable(win);
            openWins[id]=true; activeWin=id;
            const ind = document.getElementById(`indicator-${id}`); if(ind) ind.classList.remove('hidden');
            if(app.init) app.init();
            if(id==='texteditor' && args) setTimeout(()=>loadFileIntoEditor(args), 50);
            const sm = document.getElementById('start-menu'); if(!sm.classList.contains('opacity-0')) toggleStartMenu();
        }

        function focusWin(id) { document.getElementById(`win-${id}`).style.zIndex = ++zIndex; activeWin = id; }

        /* --- APP LOGIC: CALCULATOR --- */
        function calcIn(v) { const d=document.getElementById('calc-display'); d.value+=v; }
        function calcRes() { const d=document.getElementById('calc-display'); try { d.value=eval(d.value); } catch(e) { d.value="Error"; } }

        /* --- APP LOGIC: PAINT --- */
        function initPaint() {
            const cvs = document.getElementById('paint-canvas');
            const ctx = cvs.getContext('2d');
            let painting = false;
            
            // Resize canvas to match display size
            const rect = cvs.parentElement.getBoundingClientRect();
            cvs.width = rect.width; cvs.height = rect.height;

            function startPosition(e) { painting = true; draw(e); }
            function finishedPosition() { painting = false; ctx.beginPath(); }
            function draw(e) {
                if(!painting) return;
                const rect = cvs.getBoundingClientRect();
                ctx.lineWidth = 5;
                ctx.lineCap = 'round';
                ctx.strokeStyle = document.getElementById('paint-color').value;
                
                ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
            }
            cvs.addEventListener('mousedown', startPosition);
            cvs.addEventListener('mouseup', finishedPosition);
            cvs.addEventListener('mousemove', draw);
        }
        function clearPaint() { const c=document.getElementById('paint-canvas'); c.getContext('2d').clearRect(0,0,c.width,c.height); }

        /* --- DESKTOP ICONS LOGIC --- */
        function selectIcon(id) {
            document.querySelectorAll('.desktop-icon').forEach(i => i.classList.remove('selected'));
            document.getElementById(id).classList.add('selected');
        }
        function renderDesktopIcons() {
            const container = document.getElementById('desktop-icons-container');
            container.innerHTML = "";
            const sysIcons = [{ id: "icon-pc", name: "My PC", icon: "fa-server", color: "text-blue-400", action: "openApp('settings')" },{ id: "icon-term", name: "Terminal", icon: "fa-terminal", color: "text-green-500", action: "openApp('terminal')" }];
            sysIcons.forEach(i => { container.innerHTML += `<div id="${i.id}" class="desktop-icon w-[90px] h-[90px] flex flex-col items-center justify-center cursor-pointer mb-2 transition-all" onclick="selectIcon('${i.id}')" ondblclick="${i.action}"><i class="fas ${i.icon} ${i.color} text-3xl mb-2 drop-shadow-md"></i><span class="text-white text-xs text-center font-bold drop-shadow-md select-none">${i.name}</span></div>`; });
            Object.entries(fileSystem["Desktop"].content).forEach(([name, data]) => {
                const iconClass = data.type === 'dir' ? 'fa-folder text-yellow-500' : 'fa-file-alt text-gray-300';
                const action = data.type === 'file' ? `openApp('texteditor', '${name}')` : ""; 
                const id = `icon-${name.replace(/\s/g, '')}`;
                container.innerHTML += `<div id="${id}" class="desktop-icon w-[90px] h-[90px] flex flex-col items-center justify-center cursor-pointer mb-2 transition-all" onclick="selectIcon('${id}')" ondblclick="${action}"><i class="fas ${iconClass} text-3xl mb-2 drop-shadow-md"></i><span class="text-white text-xs text-center font-bold drop-shadow-md select-none break-all px-1">${name}</span></div>`;
            });
        }

        /* --- EDITOR & FILE MANAGER --- */
        function loadFileIntoEditor(fname) {
            let c = "";
            if(fileSystem.Documents.content[fname]) c = fileSystem.Documents.content[fname].content;
            else if(fileSystem.Desktop.content[fname]) c = fileSystem.Desktop.content[fname].content;
            document.getElementById('editor-filename').value = fname;
            document.getElementById('editor-content').value = c;
        }
        function saveCurrentFile() {
            const n = document.getElementById('editor-filename').value;
            const c = document.getElementById('editor-content').value;
            fileSystem.Documents.content[n] = {type:'file', content:c};
            saveDrive();
            const s = document.getElementById('editor-status'); s.style.opacity=1; setTimeout(()=>s.style.opacity=0, 1500);
            if(openWins['filemanager']) refreshFM();
        }
        function refreshFM() {
            const c = document.getElementById('fm-content'); if(!c) return;
            c.innerHTML = "";
            Object.entries(fileSystem).forEach(([d, dat]) => {
                c.innerHTML += `<div class="col-span-4 text-xs font-bold text-gray-500 mt-2 border-b uppercase">${d}</div>`;
                Object.entries(dat.content).forEach(([f, fdat]) => {
                    const ic = fdat.type === 'dir' ? 'fa-folder text-yellow-500' : 'fa-file-alt text-gray-500';
                    c.innerHTML += `<div class="flex flex-col items-center p-2 hover:bg-slate-200 rounded cursor-pointer" ondblclick="openApp('texteditor', '${f}')"><i class="fas ${ic} text-2xl"></i><span class="text-xs mt-1">${f}</span></div>`;
                });
            });
        }

        /* --- TERMINAL --- */
        function initTerminal() {
            const inp = document.getElementById('term-input'); inp.focus();
            inp.onkeydown = (e) => {
                if(e.key==='Enter') {
                    const v = inp.value; document.getElementById('term-history').innerHTML += `<div><span class="text-blue-400 font-bold">~</span> ${v}</div>`;
                    const cmd = v.split(' ')[0].toLowerCase();
                    if(cmd==='help') document.getElementById('term-history').innerHTML += `<div class="text-gray-400">ls, clear, date, reboot, crash</div>`;
                    else if(cmd==='ls') document.getElementById('term-history').innerHTML += `<div>Desktop Documents Downloads</div>`;
                    else if(cmd==='clear') document.getElementById('term-history').innerHTML = "";
                    else if(cmd==='reboot') location.reload();
                    else if(cmd==='crash') { document.getElementById('bsod').style.display='block'; document.body.style.cursor='none'; }
                    inp.value=""; inp.scrollIntoView();
                }
            }
        }

        /* --- UTILS --- */
        function toggleStartMenu() {
            const m = document.getElementById('start-menu');
            if(m.classList.contains('opacity-0')) { m.classList.remove('opacity-0','pointer-events-none','scale-90'); }
            else { m.classList.add('opacity-0','pointer-events-none','scale-90'); }
        }
        function updateClock() { document.getElementById('clock-time').innerText = new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}); setTimeout(updateClock, 1000); }
        function makeDraggable(el) {
            let pos1=0,pos2=0,pos3=0,pos4=0;
            el.querySelector('.title-bar').onmousedown = (e) => {
                e.preventDefault(); pos3=e.clientX; pos4=e.clientY;
                document.onmouseup = () => { document.onmouseup=null; document.onmousemove=null; };
                document.onmousemove = (e) => { e.preventDefault(); pos1=pos3-e.clientX; pos2=pos4-e.clientY; pos3=e.clientX; pos4=e.clientY; el.style.top=(el.offsetTop-pos2)+"px"; el.style.left=(el.offsetLeft-pos1)+"px"; };
            };
        }
    </script>
</body>
</html>
